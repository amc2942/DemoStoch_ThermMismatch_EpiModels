---
title: "Modeling Demographic Stochasticity and Thermal Mismatch in Host-Pathogen Wildlife Systems"
author: "Andy Carlino"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup:

Working Directory and Libraries:
```{r}
# Working Directory
setwd("C:\\Users\\andre\\OneDrive\\Documents\\GitHub\\DemoStoch_ThermMismatch_EpiModels")

# Libraries
library(tidyverse)
library(tidyr)
library(ggplot2)
library(stats)
library(reshape2)
library(gridExtra)
library(dplyr)
```

Source Functions:
```{r}
# Tau leap function
source("tau_leap_function.R")

# Simulation of the within-host model function
source("model_simulation_function.R")
```


# Quadratic Functions for Parameter Values along Thermal Gradient:

Thermal Performance Curve using a Quadratic function: 
$$ 
\text{Parameter} = -q * [\text{temp} - t_{min}][\text{temp} - t_{max}]
$$

Min-Max Normalization to get all parameters on 0-1 scale for easier visualization
$$
\text{Normalized Parameter} = \frac{value - min}{max - min}
$$

```{r}
# Generate temperature range
temperatures <- seq(7, 17, length.out = 50)
```

Estimating the Range of Parameter Phi (Viral Replication Rate)
```{r}
estimate_phi <- function(temperature, q_phi, tmin_phi, tmax_phi) {
  # Quadratic equation
  phi <- pmax(-q_phi * (temperature - tmin_phi) * (temperature - tmax_phi), 0) 
  return(phi)
}

# Set q for phi
q_phi <- 0.0094
# Set temperature range
tmin_phi <- 1
tmax_phi <- 30

# Calculate corresponding values of phi
phi_values <- estimate_phi(temperatures, q_phi, tmin_phi, tmax_phi)

# Min-Max normalization
norm_phi <- (phi_values - min(phi_values)) / (max(phi_values) - min(phi_values))

# Peak value of the phi Parameter
temp_peak_phi <- (tmin_phi + tmax_phi) / 2
peak_phi <- estimate_phi(temp_peak_phi, q_phi, tmin_phi, tmax_phi)
```

Estimating the Range of Parameter Alpha (Mass-action Attack Rate)
```{r}
estimate_alpha <- function(temperature, q_alpha, tmin_alpha, tmax_alpha){
  # Quadratic Equation
  alpha <- pmax(-q_alpha * (temperature - tmin_alpha) * (temperature - tmax_alpha), 0)
  return(alpha)
}

# Set q value for alpha 
q_alpha <- 0.0082
# Set temperature range
tmin_alpha <- -5
tmax_alpha <- 24

# Calculate corresponding values of alpha
alpha_values <- estimate_alpha(temperatures, q_alpha, tmin_alpha, tmax_alpha)

# Min-Max Normalization
norm_alpha <- (alpha_values - min(alpha_values)) / (max(alpha_values) - min(alpha_values))

# Peak value of the alpha Parameter
temp_peak_alpha <- (tmin_alpha + tmax_alpha) / 2
peak_alpha <- estimate_alpha(temp_peak_alpha, q_alpha, tmin_alpha, tmax_alpha)
```

Estimating the Range of Parameter Psi (Immune Growth Rate in Response to Virus)
```{r}
estimate_psi <- function(temperature, q_psi, tmin_psi, tmax_psi){
  # Quadratic Equation
  psi <- pmax(-q_psi * (temperature - tmin_psi) * (temperature - tmax_psi), 0)
  return(psi)
}

# Set q value for psi 
q_psi <- 0.0041
# Set temperature range
tmin_psi <- 1
tmax_psi <- 28

# Calculate corresponding values of alpha
psi_values <- estimate_psi(temperatures, q_psi, tmin_psi, tmax_psi)

# Min-Max normalization
norm_psi <- (psi_values - min(psi_values)) / (max(psi_values) - min(psi_values))

# Peak value of the alpha Parameter
temp_peak_psi <- (tmin_psi + tmax_psi) / 2
peak_psi <- estimate_psi(temp_peak_psi, q_psi, tmin_psi, tmax_psi)
```

Plot the functions: 
```{r}
plot_data <- data.frame(Temperature = temperatures,
                        Phi = norm_phi, 
                        Alpha = norm_alpha)
                        #Psi = psi_values)

# Plot Phi Values
phi_plot <- ggplot(plot_data, aes(x = Temperature, y = Phi)) +
  geom_line(color = "red") + 
  labs(x = "Temperature (°C)", y = "Phi (Pathogen) Values") + 
  geom_vline(xintercept = temp_peak_phi, color = "red", linetype = "dashed") + 
  theme_bw() +
  ggtitle("Temperature vs. Parameter Values") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.title = element_text(size = 20)) + 
  theme(axis.text = element_text(size = 15)) + 
  theme(axis.title = element_text(size = 15))

# Plot Alpha Values
alpha_plot <- ggplot(plot_data, aes(x = Temperature, y = Alpha)) +
  geom_line(color = "blue") + 
  labs(x = "Temperature (°C)", y = "Alpha (Host) Values") + 
  geom_vline(xintercept = temp_peak_alpha, color = "blue", linetype = "dashed") +
  theme_bw() + 
  theme(axis.text = element_text(size = 15)) + 
  theme(axis.title = element_text(size = 15))

# Plot Psi Values (Commented out, but code can easily be adopted to look at this parameter if needed...)
#psi_plot <- ggplot(plot_data, aes(x = Temperature, y = Psi)) + 
#  geom_line(color = "green") + 
#  labs(x = "Temperature (C)", y = "Psi (Immune Response to Virus) Values") + 
#  geom_vline(xintercept = temp_peak_psi, color = "green", linetype = "dashed") +
#  theme_bw() + 
#  theme(axis.text = element_text(size = 15)) + 
#  theme(axis.title = element_text(size = 15))


# To plot both parameters together with normalized values: 
plot_data_long <- plot_data %>% pivot_longer(cols = c(Phi, Alpha), names_to = "Parameter", values_to = "Value")

combined_plot <- ggplot(plot_data_long, aes(x = Temperature, y = Value, color = Parameter)) +
  geom_line() +
  geom_vline(xintercept = temp_peak_phi, color = "red", linetype = "dashed") + # For Phi peak
  geom_vline(xintercept = temp_peak_alpha, color = "blue", linetype = "dashed") + # For Alpha peak
  labs(x = "Temperature (°C)", y = "Parameter Values") +
  theme_bw() +
  ggtitle("Temperature vs. Parameter Values") +
  theme(plot.title = element_text(hjust = 0.5, size = 20),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15)) +
  scale_color_manual(values = c("Phi" = "red", "Alpha" = "blue"))

combined_plot
```


## Testing Multiple Scenarios (High, Mid [multiple], Null)
Using this format, we're going to create and test different scenarios, incrementally closing the gap between thermal optima (by bringing tmin/tmax closer for each step), ultimately testing a 'null' scenario where thermal optima completely overlap (i.e., no thermal mismatch). 

#### High Mismatch
```{r}
# FIRST: Phi value for High Mismatch
# Set temperature range (High)
tmin_phi_high <- 1
tmax_phi_high <- 30

# Calculate corresponding values of phi
phi_values_high <- estimate_phi(temperatures, q_phi, tmin_phi_high, tmax_phi_high)

# Min-Max normalization
norm_phi_high <- (phi_values_high - min(phi_values_high)) / (max(phi_values_high) - min(phi_values_high))

# Peak value of the phi Parameter
temp_peak_phi_high <- (tmin_phi_high + tmax_phi_high) / 2
peak_phi_high <- estimate_phi(temp_peak_phi_high, q_phi, tmin_phi_high, tmax_phi_high)

# ------------------------------------------------
# NEXT: Alpha value for High Mismatch
# Set temperature range
tmin_alpha_high <- -5
tmax_alpha_high <- 24

# Calculate corresponding values of alpha
alpha_values_high <- estimate_alpha(temperatures, q_alpha, tmin_alpha_high, tmax_alpha_high)

# Min-Max Normalization
norm_alpha_high <- (alpha_values_high - min(alpha_values_high)) / (max(alpha_values_high) - min(alpha_values_high))

# Peak value of the alpha Parameter
temp_peak_alpha_high <- (tmin_alpha_high + tmax_alpha_high) / 2
peak_alpha_high <- estimate_alpha(temp_peak_alpha_high, q_alpha, tmin_alpha_high, tmax_alpha_high)
```


#### Mid 1 Mismatch
```{r}
# FIRST: Phi value for Mid 1 Mismatch
# Set temperature range (High)
tmin_phi_mid1 <- 0
tmax_phi_mid1 <- 29

# Calculate corresponding values of phi
phi_values_mid1 <- estimate_phi(temperatures, q_phi, tmin_phi_mid1, tmax_phi_mid1)

# Min-Max normalization
norm_phi_mid1 <- (phi_values_mid1 - min(phi_values_mid1)) / (max(phi_values_mid1) - min(phi_values_mid1))

# Peak value of the phi Parameter
temp_peak_phi_mid1 <- (tmin_phi_mid1 + tmax_phi_mid1) / 2
peak_phi_mid1 <- estimate_phi(temp_peak_phi_mid1, q_phi, tmin_phi_mid1, tmax_phi_mid1)

# ------------------------------------------------
# NEXT: Alpha value for Mid 1 Mismatch
# Set temperature range
tmin_alpha_mid1 <- -4
tmax_alpha_mid1 <- 25

# Calculate corresponding values of alpha
alpha_values_mid1 <- estimate_alpha(temperatures, q_alpha, tmin_alpha_mid1, tmax_alpha_mid1)

# Min-Max Normalization
norm_alpha_mid1 <- (alpha_values_mid1 - min(alpha_values_mid1)) / (max(alpha_values_mid1) - min(alpha_values_mid1))

# Peak value of the alpha Parameter
temp_peak_alpha_mid1 <- (tmin_alpha_mid1 + tmax_alpha_mid1) / 2
peak_alpha_mid1 <- estimate_alpha(temp_peak_alpha_mid1, q_alpha, tmin_alpha_mid1, tmax_alpha_mid1)
```

#### Mid 2 Mismatch
```{r}
# FIRST: Phi value for Mid 2 Mismatch
# Set temperature range (High)
tmin_phi_mid2 <- -1
tmax_phi_mid2 <- 28

# Calculate corresponding values of phi
phi_values_mid2 <- estimate_phi(temperatures, q_phi, tmin_phi_mid2, tmax_phi_mid2)

# Min-Max normalization
norm_phi_mid2 <- (phi_values_mid2 - min(phi_values_mid2)) / (max(phi_values_mid2) - min(phi_values_mid2))

# Peak value of the phi Parameter
temp_peak_phi_mid2 <- (tmin_phi_mid2 + tmax_phi_mid2) / 2
peak_phi_mid2 <- estimate_phi(temp_peak_phi_mid2, q_phi, tmin_phi_mid2, tmax_phi_mid2)

# ------------------------------------------------
# NEXT: Alpha value for Mid 2 Mismatch
# Set temperature range
tmin_alpha_mid2 <- -3
tmax_alpha_mid2 <- 26

# Calculate corresponding values of alpha
alpha_values_mid2 <- estimate_alpha(temperatures, q_alpha, tmin_alpha_mid2, tmax_alpha_mid2)

# Min-Max Normalization
norm_alpha_mid2 <- (alpha_values_mid2 - min(alpha_values_mid2)) / (max(alpha_values_mid2) - min(alpha_values_mid2))

# Peak value of the alpha Parameter
temp_peak_alpha_mid2 <- (tmin_alpha_mid2 + tmax_alpha_mid2) / 2
peak_alpha_mid2 <- estimate_alpha(temp_peak_alpha_mid2, q_alpha, tmin_alpha_mid2, tmax_alpha_mid2)
```

#### No Mismatch (i.e., Null Scenario)
```{r}
# FIRST: Phi value for No Mismatch
# Set temperature range (High)
tmin_phi_null <- -2
tmax_phi_null <- 27

# Calculate corresponding values of phi
phi_values_null <- estimate_phi(temperatures, q_phi, tmin_phi_null, tmax_phi_null)

# Min-Max normalization
norm_phi_null <- (phi_values_null - min(phi_values_null)) / (max(phi_values_null) - min(phi_values_null))

# Peak value of the phi Parameter
temp_peak_phi_null <- (tmin_phi_null + tmax_phi_null) / 2
peak_phi_null <- estimate_phi(temp_peak_phi_null, q_phi, tmin_phi_null, tmax_phi_null)

# ------------------------------------------------
# NEXT: Alpha value for No Mismatch
# Set temperature range
tmin_alpha_null <- -2
tmax_alpha_null <- 27

# Calculate corresponding values of alpha
alpha_values_null <- estimate_alpha(temperatures, q_alpha, tmin_alpha_null, tmax_alpha_null)

# Min-Max Normalization
norm_alpha_null <- (alpha_values_null - min(alpha_values_null)) / (max(alpha_values_null) - min(alpha_values_null))

# Peak value of the alpha Parameter
temp_peak_alpha_null <- (tmin_alpha_null + tmax_alpha_null) / 2
peak_alpha_null <- estimate_alpha(temp_peak_alpha_null, q_alpha, tmin_alpha_null, tmax_alpha_null)
```

#### Now we can plot the scenarios: 
```{r, fig.height = 8, fig.width = 5}
param_function_plot_data <- data.frame(
  Temperature = rep(temperatures, 4), 
  Normalized_Phi = c(norm_phi_high, norm_phi_mid1, norm_phi_mid2, norm_phi_null), 
  Normalized_Alpha = c(norm_alpha_high, norm_alpha_mid1, norm_alpha_mid2, norm_alpha_null),
  Scenario = factor(rep(c("High Mismatch", "Mid 1 Mismatch", "Mid 2 Mismatch", "No Mismatch"), each = length(temperatures)))
)

optimal_temps <- data.frame(
  Scenario = factor(c("High Mismatch", "Mid 1 Mismatch", "Mid 2 Mismatch", "No Mismatch")),
  Temp_Peak_Phi_opt = c(temp_peak_phi_high, temp_peak_phi_mid1, temp_peak_phi_mid2, temp_peak_phi_null),
  Temp_Peak_Alpha_opt = c(temp_peak_alpha_high, temp_peak_alpha_mid1, temp_peak_alpha_mid2, temp_peak_alpha_null)
)

# pivot for ggplot
param_function_plot_data_long <- param_function_plot_data %>% 
  pivot_longer(cols = c(Normalized_Phi, Normalized_Alpha), 
               names_to = "Parameter", values_to = "Normalized_Value")

quad_param_plot_data <- merge(param_function_plot_data_long, optimal_temps, by = "Scenario")
quad_param_plot_data$Parameter <- factor(quad_param_plot_data$Parameter, 
                                          levels = c("Normalized_Phi", "Normalized_Alpha"))

# Create the plot
quad_param_plot <- ggplot(quad_param_plot_data, 
                          aes(x = Temperature, y = Normalized_Value, color = Parameter)) + 
  geom_line(size = 1) + 
  facet_wrap(~ Scenario, ncol = 1,
             labeller = labeller(Scenario = c("No Mismatch" = "No Mismatch (Functions Overlap)",
                                              "High Mismatch" = "High Mismatch",
                                              "Mid 1 Mismatch" = "Mid 1 Mismatch", 
                                              "Mid 2 Mismatch" = "Mid 2 Mismatch"))) +
  scale_color_manual(values = c("Normalized_Phi" = "red", "Normalized_Alpha" = "blue"),
                     labels = c("Phi (Virus)", "Alpha (Host)")) + 
  geom_vline(aes(xintercept = Temp_Peak_Phi_opt), linetype = "dashed", col = "red", linewidth = 0.8) + 
  geom_vline(aes(xintercept = Temp_Peak_Alpha_opt), linetype = "dashed", col = "blue", linewidth = 0.8) +
  theme_bw() + 
  labs(x = "Temperature (°C)", y = "Parameter Values (Normalized)", 
       color = "Parameter:", title = "Thermal Mismatch Scenarios") +
  theme(strip.text = element_text(size = 10, face = "bold"), 
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))

quad_param_plot
```

# Running the Model (Multiple Temperatures and Multiple Scenarios)

First, setup the code to run model simulations. Then use the parameter values (for phi and alpha) calculated above to run the model at the different scenarios and along the thermal gradient. 

Initial setup of universal variables/parameters: 
```{r}
# Set time/tau: 
tau <- 1 # leap size
t_max <- 40 # days
n_times <- floor(t_max/tau)
t_vec <- seq(1, t_max, length.out = n_times)

# Vector to store Viral and Immune Load
V_vec <- vector(mode = "numeric", length = n_times)
Z_vec <- vector(mode = "numeric", length = n_times)

z_scalar <- 1000

death_threshold <- 3000
clearance_threshold <- 0

# Set initial values
V_vec[1] <- 250                      # Initial viral density 
Z_vec[1] <- rpois(1, 0.35*z_scalar)  # Initial immune component density 

# Set number of iterations per scenario per temperature: 
num_sims <- 100

# Set temperatures to check: 
temp_checks <- c(10, 12.5, 15)
```

#### High mismatch
```{r, warning=FALSE}
# Set parameters for high mismatch scenario
params_high <- list(
  phi = estimate_phi(temp_checks[1], q_phi, tmin_phi_high, tmax_phi_high), # Viral replication rate (estimate_phi function)
  alpha = estimate_alpha(temp_checks[1], q_alpha, tmin_alpha_high, tmax_alpha_high), # Mass-action attack rate (estimate_alpha function)
  delta = 1.29,            # Rate of decline that ensures return of immune system to homeostasis
  psi = 0.91,              # Immune component growth rate in response to virus
  gamma = 0.13,            # Half saturation constant
  N_z = 1.29 * 0.35,       # Rate of production that ensures return of immune system to homeostasis
  z_scalar = z_scalar      # To scale the immune variables
)

# Store results for high mismatch: 
results_high <- list()

# Loop through each set temperature for high mismatch scenario: 
for (temp in temp_checks) {
  # Set temperature-specific params
  params_high$phi <- estimate_phi(temp, q_phi, tmin_phi_high, tmax_phi_high)
  params_high$alpha <- estimate_alpha(temp, q_alpha, tmin_alpha_high, tmax_alpha_high)
  
  # Initialize a list to store simulation results for the current temperature
  temp_results_high <- vector("list", num_sims)
  
  # Run model for all simulations: 
  for (sim in 1:num_sims) {
    sim_results <- model_simulation(
      V_vec = V_vec, 
      Z_vec = Z_vec, 
      params = params_high,
      death_threshold = death_threshold,
      clearance_threshold = clearance_threshold
    )
    
    # Store the simulation results as a list
    temp_results_high[[sim]] <- list(Simulation = sim, 
                                     V_vec = sim_results$V_vec, 
                                     Z_vec = sim_results$Z_vec)
  }
  
  # Convert the list of simulation results to a data frame
  temp_results_high_df <- do.call(rbind, lapply(temp_results_high, as.data.frame))
  
  # Add results for this temperature to the overall list
  results_high[[paste0("Temp", temp)]] <- temp_results_high_df
}

```

#### Mid 1 Mismatch
```{r, warning=FALSE}
# Set parameters for mid 1 mismatch scenario
params_mid1 <- list(
  phi = estimate_phi(temp_checks[1], q_phi, tmin_phi_mid1, tmax_phi_mid1), # Viral replication rate (estimate_phi function)
  alpha = estimate_alpha(temp_checks[1], q_alpha, tmin_alpha_mid1, tmax_alpha_mid1), # Mass-action attack rate (estimate_alpha function)
  delta = 1.29,            # Rate of decline that ensures return of immune system to homeostasis
  psi = 0.91,              # Immune component growth rate in response to virus
  gamma = 0.13,            # Half saturation constant
  N_z = 1.29 * 0.35,       # Rate of production that ensures return of immune system to homeostasis
  z_scalar = z_scalar      # To scale the immune variables
)

# Store results for mid 1 mismatch: 
results_mid1 <- list()

# Loop through each set temperature for mid 1 mismatch scenario: 
for (temp in temp_checks) {
  # Set temperature-specific params
  params_mid1$phi <- estimate_phi(temp, q_phi, tmin_phi_mid1, tmax_phi_mid1)
  params_mid1$alpha <- estimate_alpha(temp, q_alpha, tmin_alpha_mid1, tmax_alpha_mid1)
  
  # Initialize a list to store simulation results for the current temperature
  temp_results_mid1 <- vector("list", num_sims)
  
  # Run model for all simulations: 
  for (sim in 1:num_sims) {
    sim_results <- model_simulation(
      V_vec = V_vec, 
      Z_vec = Z_vec, 
      params = params_mid1,
      death_threshold = death_threshold,
      clearance_threshold = clearance_threshold
    )
    
    # Store the simulation results as a list
    temp_results_mid1[[sim]] <- list(Simulation = sim, 
                                     V_vec = sim_results$V_vec, 
                                     Z_vec = sim_results$Z_vec)
  }
  
  # Convert the list of simulation results to a data frame
  temp_results_mid1_df <- do.call(rbind, lapply(temp_results_mid1, as.data.frame))
  
  # Add results for this temperature to the overall list
  results_mid1[[paste0("Temp", temp)]] <- temp_results_mid1_df
}

```

#### Mid 2 Mismatch
```{r, warning=FALSE}
# Set parameters for mid 2 mismatch scenario
params_mid2 <- list(
  phi = estimate_phi(temp_checks[1], q_phi, tmin_phi_mid2, tmax_phi_mid2), # Viral replication rate (estimate_phi function)
  alpha = estimate_alpha(temp_checks[1], q_alpha, tmin_alpha_mid2, tmax_alpha_mid2), # Mass-action attack rate (estimate_alpha function)
  delta = 1.29,            # Rate of decline that ensures return of immune system to homeostasis
  psi = 0.91,              # Immune component growth rate in response to virus
  gamma = 0.13,            # Half saturation constant
  N_z = 1.29 * 0.35,       # Rate of production that ensures return of immune system to homeostasis
  z_scalar = z_scalar      # To scale the immune variables
)

# Store results for mid 2 mismatch: 
results_mid2 <- list()

# Loop through each set temperature for mid 2 mismatch scenario: 
for (temp in temp_checks) {
  # Set temperature-specific params
  params_mid2$phi <- estimate_phi(temp, q_phi, tmin_phi_mid2, tmax_phi_mid2)
  params_mid2$alpha <- estimate_alpha(temp, q_alpha, tmin_alpha_mid2, tmax_alpha_mid2)
  
  # Initialize a list to store simulation results for the current temperature
  temp_results_mid2 <- vector("list", num_sims)
  
  # Run model for all simulations: 
  for (sim in 1:num_sims) {
    sim_results <- model_simulation(
      V_vec = V_vec, 
      Z_vec = Z_vec, 
      params = params_mid2,
      death_threshold = death_threshold,
      clearance_threshold = clearance_threshold
    )
    
    # Store the simulation results as a list
    temp_results_mid2[[sim]] <- list(Simulation = sim, 
                                     V_vec = sim_results$V_vec, 
                                     Z_vec = sim_results$Z_vec)
  }
  
  # Convert the list of simulation results to a data frame
  temp_results_mid2_df <- do.call(rbind, lapply(temp_results_mid2, as.data.frame))
  
  # Add results for this temperature to the overall list
  results_mid2[[paste0("Temp", temp)]] <- temp_results_mid2_df
}
```

#### No Mismatch (i.e., Null hypothesis)
```{r, warning=FALSE}
# Set parameters for no mismatch scenario
params_null <- list(
  phi = estimate_phi(temp_checks[1], q_phi, tmin_phi_null, tmax_phi_null), # Viral replication rate (estimate_phi function)
  alpha = estimate_alpha(temp_checks[1], q_alpha, tmin_alpha_null, tmax_alpha_null), # Mass-action attack rate (estimate_alpha function)
  delta = 1.29,            # Rate of decline that ensures return of immune system to homeostasis
  psi = 0.91,              # Immune component growth rate in response to virus
  gamma = 0.13,            # Half saturation constant
  N_z = 1.29 * 0.35,       # Rate of production that ensures return of immune system to homeostasis
  z_scalar = z_scalar      # To scale the immune variables
)

# Store results for mid 2 mismatch: 
results_null <- list()

# Loop through each set temperature for mid 2 mismatch scenario: 
for (temp in temp_checks) {
  # Set temperature-specific params
  params_null$phi <- estimate_phi(temp, q_phi, tmin_phi_null, tmax_phi_null)
  params_null$alpha <- estimate_alpha(temp, q_alpha, tmin_alpha_null, tmax_alpha_null)
  
  # Initialize a list to store simulation results for the current temperature
  temp_results_null <- vector("list", num_sims)
  
  # Run model for all simulations: 
  for (sim in 1:num_sims) {
    sim_results <- model_simulation(
      V_vec = V_vec, 
      Z_vec = Z_vec, 
      params = params_null,
      death_threshold = death_threshold,
      clearance_threshold = clearance_threshold
    )
    
    # Store the simulation results as a list
    temp_results_null[[sim]] <- list(Simulation = sim, 
                                     V_vec = sim_results$V_vec, 
                                     Z_vec = sim_results$Z_vec)
  }
  
  # Convert the list of simulation results to a data frame
  temp_results_null_df <- do.call(rbind, lapply(temp_results_null, as.data.frame))
  
  # Add results for this temperature to the overall list
  results_null[[paste0("Temp", temp)]] <- temp_results_null_df
}
```

#### Create plot with all results (4 Scenarios, 3 Temps each)
```{r}
# Function to combine the results
combine_results <- function(results_list, scenario_name){
  do.call(rbind, lapply(names(results_list), function(temp_name){
    temp_data <- results_list[[temp_name]]
    temp_data$Scenario <- scenario_name
    temp_data$Temperature <- as.numeric(gsub("Temp", "", temp_name))
    return(temp_data)
  }))
}

# All scenarios to one data frame
all_combined_results <- rbind(
  combine_results(results_high, "High"),
  combine_results(results_mid1, "Mid1"),
  combine_results(results_mid2, "Mid2"),
  combine_results(results_null, "Null")
)

# Summary stats for Confidence intervals and medians for plotting
summary_results <- all_combined_results %>%
  tidyr::unnest(cols = c(V_vec, Z_vec)) %>%
  group_by(Scenario, Temperature) %>%
  mutate(Day = rep(1:40, times = n() / 40)) %>% 
  group_by(Scenario, Temperature, Day) %>%
  summarise(
    V_median = median(V_vec, na.rm = TRUE),
    V_low = quantile(V_vec, 0.025, na.rm = TRUE),
    V_high = quantile(V_vec, 0.975, na.rm = TRUE),
    Z_median = median(Z_vec, na.rm = TRUE),
    Z_low = quantile(Z_vec, 0.025, na.rm = TRUE),
    Z_high = quantile(Z_vec, 0.975, na.rm = TRUE),
    .groups = "drop"
  )
```

```{r, warning = FALSE, fig.height = 8, fig.width=10}
# Create the figure (facet_wrap, rows are scenarios, columns are temperatures)
scenario_by_temp_plot <- ggplot(summary_results, aes(x = Day)) + 
  # V_vec
  geom_ribbon(aes(ymin = V_low, ymax = V_high, fill = "V_vec"), alpha = 0.3) + 
  geom_line(aes(y = V_median, color = "V_vec"), size = 1.2) + 
  # Z_vec
  geom_ribbon(aes(ymin = Z_low, ymax = Z_high, fill = "Z_vec"), alpha = 0.3) + 
  geom_line(aes(y = Z_median, color = "Z_vec"), size = 1.2) + 
  # facet by scenario and temperature
  facet_grid(Scenario ~ Temperature,
             labeller = labeller(Temperature = function(x) paste0(x, " °C"),
                                 Scenario = function(x) paste0(x, " Mismatch"),
                                 )) +
  # aesthetics:
  scale_fill_manual(
    name = "Variable: ",
    values = c("V_vec" = "red", "Z_vec" = "blue"),
    labels = c("Viral Cell Load", "Immune Cell Load")
  ) + 
  scale_color_manual(
    name = "Variable: ",
    values = c("V_vec" = "red", "Z_vec" = "blue"),
    labels = c("Viral Cell Load", "Immune Cell Load")
  ) + 
  labs(title = "Simulation Results by Mismatch Scenario and by Temperature",
       x = "Days",
       y = "Within-Host Cell Density/Load") + 
  theme_bw(base_size = 14) + 
  theme(legend.position = "bottom", 
        legend.box = "horizontal",
        panel.grid = element_line(color = "gray90"),
        plot.title = element_text(hjust = 0.5, size = 14))

scenario_by_temp_plot
```


# Track the Proportion of deaths across thermal gradient