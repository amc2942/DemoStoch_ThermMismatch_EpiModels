---
title: "Modeling Demographic Stochasticity and Thermal Mismatch in Host-Pathogen Wildlife Systems"
author: "Andy Carlino"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup:

Working Directory and Libraries:
```{r}
# Working Directory
setwd("C:\\Users\\andre\\OneDrive\\Documents\\GitHub\\DemoStoch_ThermMismatch_EpiModels")

# Libraries
library(tidyverse)
library(tidyr)
library(ggplot2)
library(stats)
library(reshape2)
library(gridExtra)
```

Source Functions:
```{r}
# Tau leap function
source("tau_leap_function.R")

# Simulation of the within-host model function
source("model_simulation_function.R")
```


# Quadratic Functions for Parameter Values along Thermal Gradient:

Thermal Performance Curve using a Quadratic function: 
$$ 
\text{Parameter} = -q * [\text{temp} - t_{min}][\text{temp} - t_{max}]
$$

Min-Max Normalization to get all parameters on 0-1 scale for easier visualization
$$
\text{Normalized Parameter} = \frac{value - min}{max - min}
$$

```{r}
# Generate temperature range
temperatures <- seq(7, 17, length.out = 50)
```

Estimating the Range of Parameter Phi (Viral Replication Rate)
```{r}
estimate_phi <- function(temperature, q_phi, tmin_phi, tmax_phi) {
  # Quadratic equation
  phi <- pmax(-q_phi * (temperature - tmin_phi) * (temperature - tmax_phi), 0) 
  return(phi)
}

# Set q for phi
q_phi <- 0.01275
# Set temperature range
tmin_phi <- 1
tmax_phi <- 30

# Calculate corresponding values of phi
phi_values <- estimate_phi(temperatures, q_phi, tmin_phi, tmax_phi)

# Min-Max normalization
norm_phi <- (phi_values - min(phi_values)) / (max(phi_values) - min(phi_values))

# Peak value of the phi Parameter
temp_peak_phi <- (tmin_phi + tmax_phi) / 2
peak_phi <- estimate_phi(temp_peak_phi, q_phi, tmin_phi, tmax_phi)
```

Estimating the Range of Parameter Alpha (Mass-action Attack Rate)
```{r}
estimate_alpha <- function(temperature, q_alpha, tmin_alpha, tmax_alpha){
  # Quadratic Equation
  alpha <- pmax(-q_alpha * (temperature - tmin_alpha) * (temperature - tmax_alpha), 0)
  return(alpha)
}

# Set q value for alpha 
q_alpha <- 0.00855
# Set temperature range
tmin_alpha <- -5
tmax_alpha <- 24

# Calculate corresponding values of alpha
alpha_values <- estimate_alpha(temperatures, q_alpha, tmin_alpha, tmax_alpha)

# Min-Max Normalization
norm_alpha <- (alpha_values - min(alpha_values)) / (max(alpha_values) - min(alpha_values))

# Peak value of the alpha Parameter
temp_peak_alpha <- (tmin_alpha + tmax_alpha) / 2
peak_alpha <- estimate_alpha(temp_peak_alpha, q_alpha, tmin_alpha, tmax_alpha)
```

Estimating the Range of Parameter Psi (Immune Growth Rate in Response to Virus)
```{r}
estimate_psi <- function(temperature, q_psi, tmin_psi, tmax_psi){
  # Quadratic Equation
  psi <- pmax(-q_psi * (temperature - tmin_psi) * (temperature - tmax_psi), 0)
  return(psi)
}

# Set q value for psi 
q_psi <- 0.0041
# Set temperature range
tmin_psi <- 1
tmax_psi <- 28

# Calculate corresponding values of alpha
psi_values <- estimate_psi(temperatures, q_psi, tmin_psi, tmax_psi)

# Min-Max normalization
norm_psi <- (psi_values - min(psi_values)) / (max(psi_values) - min(psi_values))

# Peak value of the alpha Parameter
temp_peak_psi <- (tmin_psi + tmax_psi) / 2
peak_psi <- estimate_psi(temp_peak_psi, q_psi, tmin_psi, tmax_psi)
```

Plot the functions: 
```{r}
plot_data <- data.frame(Temperature = temperatures,
                        Phi = norm_phi, 
                        Alpha = norm_alpha)
                        #Psi = psi_values)

# Plot Phi Values
phi_plot <- ggplot(plot_data, aes(x = Temperature, y = Phi)) +
  geom_line(color = "red") + 
  labs(x = "Temperature (째C)", y = "Phi (Pathogen) Values") + 
  geom_vline(xintercept = temp_peak_phi, color = "red", linetype = "dashed") + 
  theme_bw() +
  ggtitle("Temperature vs. Parameter Values") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.title = element_text(size = 20)) + 
  theme(axis.text = element_text(size = 15)) + 
  theme(axis.title = element_text(size = 15))

# Plot Alpha Values
alpha_plot <- ggplot(plot_data, aes(x = Temperature, y = Alpha)) +
  geom_line(color = "blue") + 
  labs(x = "Temperature (째C)", y = "Alpha (Host) Values") + 
  geom_vline(xintercept = temp_peak_alpha, color = "blue", linetype = "dashed") +
  theme_bw() + 
  theme(axis.text = element_text(size = 15)) + 
  theme(axis.title = element_text(size = 15))

# Plot Psi Values (Commented out, but code can easily be adopted to look at this parameter if needed...)
#psi_plot <- ggplot(plot_data, aes(x = Temperature, y = Psi)) + 
#  geom_line(color = "green") + 
#  labs(x = "Temperature (C)", y = "Psi (Immune Response to Virus) Values") + 
#  geom_vline(xintercept = temp_peak_psi, color = "green", linetype = "dashed") +
#  theme_bw() + 
#  theme(axis.text = element_text(size = 15)) + 
#  theme(axis.title = element_text(size = 15))


# To plot both parameters together with normalized values: 
plot_data_long <- plot_data %>% pivot_longer(cols = c(Phi, Alpha), names_to = "Parameter", values_to = "Value")

combined_plot <- ggplot(plot_data_long, aes(x = Temperature, y = Value, color = Parameter)) +
  geom_line() +
  geom_vline(xintercept = temp_peak_phi, color = "red", linetype = "dashed") + # For Phi peak
  geom_vline(xintercept = temp_peak_alpha, color = "blue", linetype = "dashed") + # For Alpha peak
  labs(x = "Temperature (째C)", y = "Parameter Values") +
  theme_bw() +
  ggtitle("Temperature vs. Parameter Values") +
  theme(plot.title = element_text(hjust = 0.5, size = 20),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15)) +
  scale_color_manual(values = c("Phi" = "red", "Alpha" = "blue"))

combined_plot
```


## Testing Multiple Scenarios (High, Mid [multiple], Null)
Using this format, we're going to create and test different scenarios, incrementally closing the gap between thermal optima (by bringing tmin/tmax closer for each step), ultimately testing a 'null' scenario where thermal optima completely overlap (i.e., no thermal mismatch). 

#### High Mismatch
```{r}
# FIRST: Phi value for High Mismatch
# Set q for phi (Constant; Same for all)
q_phi <- 0.01275
# Set temperature range (High)
tmin_phi_high <- 1
tmax_phi_high <- 30

# Calculate corresponding values of phi
phi_values_high <- estimate_phi(temperatures, q_phi, tmin_phi_high, tmax_phi_high)

# Min-Max normalization
norm_phi_high <- (phi_values_high - min(phi_values_high)) / (max(phi_values_high) - min(phi_values_high))

# Peak value of the phi Parameter
temp_peak_phi_high <- (tmin_phi_high + tmax_phi_high) / 2
peak_phi_high <- estimate_phi(temp_peak_phi_high, q_phi, tmin_phi_high, tmax_phi_high)

# ------------------------------------------------
# NEXT: Alpha value for High Mismatch
# Set q value for alpha (Constant for all scenarios)
q_alpha <- 0.00855
# Set temperature range
tmin_alpha_high <- -5
tmax_alpha_high <- 24

# Calculate corresponding values of alpha
alpha_values_high <- estimate_alpha(temperatures, q_alpha, tmin_alpha_high, tmax_alpha_high)

# Min-Max Normalization
norm_alpha_high <- (alpha_values_high - min(alpha_values_high)) / (max(alpha_values_high) - min(alpha_values_high))

# Peak value of the alpha Parameter
temp_peak_alpha_high <- (tmin_alpha_high + tmax_alpha_high) / 2
peak_alpha_high <- estimate_alpha(temp_peak_alpha_high, q_alpha, tmin_alpha_high, tmax_alpha_high)
```


#### Mid 1 Mismatch
```{r}
# FIRST: Phi value for Mid 1 Mismatch
# Set q for phi (Constant; Same for all)
q_phi <- 0.01275
# Set temperature range (High)
tmin_phi_mid1 <- 0
tmax_phi_mid1 <- 29

# Calculate corresponding values of phi
phi_values_mid1 <- estimate_phi(temperatures, q_phi, tmin_phi_mid1, tmax_phi_mid1)

# Min-Max normalization
norm_phi_mid1 <- (phi_values_mid1 - min(phi_values_mid1)) / (max(phi_values_mid1) - min(phi_values_mid1))

# Peak value of the phi Parameter
temp_peak_phi_mid1 <- (tmin_phi_mid1 + tmax_phi_mid1) / 2
peak_phi_mid1 <- estimate_phi(temp_peak_phi_mid1, q_phi, tmin_phi_mid1, tmax_phi_mid1)

# ------------------------------------------------
# NEXT: Alpha value for Mid 1 Mismatch
# Set q value for alpha (Constant for all scenarios)
q_alpha <- 0.00855
# Set temperature range
tmin_alpha_mid1 <- -4
tmax_alpha_mid1 <- 25

# Calculate corresponding values of alpha
alpha_values_mid1 <- estimate_alpha(temperatures, q_alpha, tmin_alpha_mid1, tmax_alpha_mid1)

# Min-Max Normalization
norm_alpha_mid1 <- (alpha_values_mid1 - min(alpha_values_mid1)) / (max(alpha_values_mid1) - min(alpha_values_mid1))

# Peak value of the alpha Parameter
temp_peak_alpha_mid1 <- (tmin_alpha_mid1 + tmax_alpha_mid1) / 2
peak_alpha_mid1 <- estimate_alpha(temp_peak_alpha_mid1, q_alpha, tmin_alpha_mid1, tmax_alpha_mid1)
```

#### Mid 2 Mismatch
```{r}
# FIRST: Phi value for Mid 2 Mismatch
# Set q for phi (Constant; Same for all)
q_phi <- 0.01275
# Set temperature range (High)
tmin_phi_mid2 <- -1
tmax_phi_mid2 <- 28

# Calculate corresponding values of phi
phi_values_mid2 <- estimate_phi(temperatures, q_phi, tmin_phi_mid2, tmax_phi_mid2)

# Min-Max normalization
norm_phi_mid2 <- (phi_values_mid2 - min(phi_values_mid2)) / (max(phi_values_mid2) - min(phi_values_mid2))

# Peak value of the phi Parameter
temp_peak_phi_mid2 <- (tmin_phi_mid2 + tmax_phi_mid2) / 2
peak_phi_mid2 <- estimate_phi(temp_peak_phi_mid2, q_phi, tmin_phi_mid2, tmax_phi_mid2)

# ------------------------------------------------
# NEXT: Alpha value for Mid 2 Mismatch
# Set q value for alpha (Constant for all scenarios)
q_alpha <- 0.00855
# Set temperature range
tmin_alpha_mid2 <- -3
tmax_alpha_mid2 <- 26

# Calculate corresponding values of alpha
alpha_values_mid2 <- estimate_alpha(temperatures, q_alpha, tmin_alpha_mid2, tmax_alpha_mid2)

# Min-Max Normalization
norm_alpha_mid2 <- (alpha_values_mid2 - min(alpha_values_mid2)) / (max(alpha_values_mid2) - min(alpha_values_mid2))

# Peak value of the alpha Parameter
temp_peak_alpha_mid2 <- (tmin_alpha_mid2 + tmax_alpha_mid2) / 2
peak_alpha_mid2 <- estimate_alpha(temp_peak_alpha_mid2, q_alpha, tmin_alpha_mid2, tmax_alpha_mid2)
```

#### No Mismatch (i.e., Null Scenario)
```{r}
# FIRST: Phi value for No Mismatch
# Set q for phi (Constant; Same for all)
q_phi <- 0.01275
# Set temperature range (High)
tmin_phi_null <- -2
tmax_phi_null <- 27

# Calculate corresponding values of phi
phi_values_null <- estimate_phi(temperatures, q_phi, tmin_phi_null, tmax_phi_null)

# Min-Max normalization
norm_phi_null <- (phi_values_null - min(phi_values_null)) / (max(phi_values_null) - min(phi_values_null))

# Peak value of the phi Parameter
temp_peak_phi_null <- (tmin_phi_null + tmax_phi_null) / 2
peak_phi_null <- estimate_phi(temp_peak_phi_null, q_phi, tmin_phi_null, tmax_phi_null)

# ------------------------------------------------
# NEXT: Alpha value for No Mismatch
# Set q value for alpha (Constant for all scenarios)
q_alpha <- 0.00855
# Set temperature range
tmin_alpha_null <- -2
tmax_alpha_null <- 27

# Calculate corresponding values of alpha
alpha_values_null <- estimate_alpha(temperatures, q_alpha, tmin_alpha_null, tmax_alpha_null)

# Min-Max Normalization
norm_alpha_null <- (alpha_values_null - min(alpha_values_null)) / (max(alpha_values_null) - min(alpha_values_null))

# Peak value of the alpha Parameter
temp_peak_alpha_null <- (tmin_alpha_null + tmax_alpha_null) / 2
peak_alpha_null <- estimate_alpha(temp_peak_alpha_null, q_alpha, tmin_alpha_null, tmax_alpha_null)
```

#### Now we can plot the scenarios: 
```{r, fig.height = 8, fig.width = 5}
param_function_plot_data <- data.frame(
  Temperature = rep(temperatures, 4), 
  Normalized_Phi = c(norm_phi_high, norm_phi_mid1, norm_phi_mid2, norm_phi_null), 
  Normalized_Alpha = c(norm_alpha_high, norm_alpha_mid1, norm_alpha_mid2, norm_alpha_null),
  Scenario = factor(rep(c("High Mismatch", "Mid 1 Mismatch", "Mid 2 Mismatch", "No Mismatch"), each = length(temperatures)))
)

optimal_temps <- data.frame(
  Scenario = factor(c("High Mismatch", "Mid 1 Mismatch", "Mid 2 Mismatch", "No Mismatch")),
  Temp_Peak_Phi_opt = c(temp_peak_phi_high, temp_peak_phi_mid1, temp_peak_phi_mid2, temp_peak_phi_null),
  Temp_Peak_Alpha_opt = c(temp_peak_alpha_high, temp_peak_alpha_mid1, temp_peak_alpha_mid2, temp_peak_alpha_null)
)

# pivot for ggplot
param_function_plot_data_long <- param_function_plot_data %>% 
  pivot_longer(cols = c(Normalized_Phi, Normalized_Alpha), 
               names_to = "Parameter", values_to = "Normalized_Value")

quad_param_plot_data <- merge(param_function_plot_data_long, optimal_temps, by = "Scenario")

# Create the plot
quad_param_plot <- ggplot(quad_param_plot_data, 
                          aes(x = Temperature, y = Normalized_Value, color = Parameter)) + 
  geom_line(size = 1) + 
  facet_wrap(~ Scenario, ncol = 1) +
  scale_color_manual(values = c("Normalized_Phi" = "red", "Normalized_Alpha" = "blue"),
                     labels = c("Phi (Virus)", "Alpha (Host)")) + 
  geom_vline(aes(xintercept = Temp_Peak_Phi_opt), linetype = "dashed", col = "red", size = 0.8) + 
  geom_vline(aes(xintercept = Temp_Peak_Alpha_opt), linetype = "dashed", col = "blue", size = 0.8) +
  theme_bw() + 
  labs(x = "Temperature (째C)", y = "Normalized Parameter Values", 
       color = "Parameter", title = "Thermal Mismatch Scenarios") +
  theme(strip.text = element_text(size = 10, face = "bold"), 
        legend.position = "bottom",
        plot.title = element_text(hjust = 0.5, size = 14, face = "bold"))

quad_param_plot
```

# Running the Model (Multiple Temperatures and Multiple Scenarios)

First, setup the code to run model simulations. Then use the parameter values (for phi and alpha) calculated above to run the model at the different scenarios and along the thermal gradient. 

